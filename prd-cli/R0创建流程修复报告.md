# R0 创建流程修复报告

**修复时间**: 2025-12-19  
**版本**: 1.1.2 → 1.1.3（待发布）  
**修复类型**: 流程控制强化

---

## 📌 问题描述

### 用户反馈

用户在完成 P0 和 A0 后，说"现在创建 R0"，AI 直接自动执行了 `prd baseline create R0` 命令，**没有和用户确认**，也**没有检查前置条件**（A1 是否完成）。

### 截图分析

从用户截图可以看到：
1. 用户说："P0 已完善，现在创建 R0："
2. AI 自动执行了命令：`cd ... && npx prd baseline create R0`
3. R0 被创建，AI 给出了审视结论
4. **问题**：整个过程没有和用户确认，也没有检查 A0/A1 是否完成

### 问题根源

**R0 基线审视工作流 (`prd-r0-baseline-review.md`) 缺少强制检查机制：**

1. **没有前置条件检查要求**
   - 工作流没有要求 AI 检查 P0、A0、A1 是否完成
   - AI 可能在基线文档不完整时就创建 R0

2. **没有 PM 确认流程**
   - 工作流没有要求 AI 必须与 PM 确认后才能创建 R0
   - AI 可能自动执行命令，绕过用户决策

3. **没有明确的行为红线**
   - 工作流没有明确禁止 AI 自动执行创建命令
   - 没有规定 AI 的正确行为模式（检查+确认）

### 影响范围

- R0 可能在基线文档不完整时就被创建
- 审视结果可能不准确（缺少 A1 数据）
- 用户失去对流程的控制权
- 违反了"PM 决策，AI 执行"的核心原则

---

## 🔧 修复方案

### 核心修复：增加 R0 创建前的强制检查机制

在 `/prd-cli/.agent/workflows/prd-r0-baseline-review.md` 开头增加：

#### 1. 前置条件检查（AI 必须执行）

当 PM 提出"创建 R0"或"开始 R0 审视"时，AI 必须先检查：

```markdown
AI: "在创建 R0 之前，我需要检查前置条件：

     ✅ 前置条件检查：
     
     1. P0_项目基本信息.md 
        状态：[✅ 已完成 / ❌ 未完成]
        
     2. A0_产品基础与范围说明.md
        状态：[✅ 已创建 / ❌ 未创建]
        
     3. A1_已上线功能与流程清单.md
        状态：[✅ 已创建 / ❌ 未创建]
        
     4. A2_存量反馈与数据汇总.md（可选但建议）
        状态：[✅ 已创建 / ⚠️ 未创建 / - 不适用]
     
     检查结果：[通过 / 不通过]"
```

#### 2. 前置条件不满足时的处理

如果 P0、A0、A1 中任何一个未完成，AI 必须：

```markdown
AI: "❌ 前置条件检查未通过！

     缺失文档：
     - [ ] P0_项目基本信息.md
     - [ ] A0_产品基础与范围说明.md
     - [ ] A1_已上线功能与流程清单.md
     
     R0 基线审视必须基于完整的 A 类基线文档。
     
     请先完成缺失的文档：
     1. 完善 P0（如果未完成）
     2. 创建 A0：prd baseline create A0
     3. 创建 A1：prd baseline create A1
     4. 创建 A2（可选）：prd baseline create A2
     
     完成后再创建 R0。
     
     ⚠️ 我已拒绝创建 R0，请完成前置文档后重试。"
```

**AI 必须拒绝创建，不得自动执行命令！**

#### 3. 前置条件满足时的确认流程

如果所有前置条件都满足，AI 必须与 PM 确认：

```markdown
AI: "✅ 前置条件检查通过！

     已完成的文档：
     ✅ P0_项目基本信息.md
     ✅ A0_产品基础与范围说明.md
     ✅ A1_已上线功能与流程清单.md
     ✅ A2_存量反馈与数据汇总.md（或已确认不需要）
     
     现在可以开始 R0 基线审视。
     
     R0 审视将：
     1. 系统性审视产品基线（基于 A0/A1/A2）
     2. 梳理用户路径和问题
     3. 识别 CSF（关键成功因素）
     4. 给出基线稳定性判定
     
     请问是否确认创建 R0 基线审视报告？
     
     确认后，我将执行：prd baseline create R0"
```

**PM 必须明确回复"确认"或"是"，AI 才能建议执行命令。**

#### 4. AI 行为红线

**AI 在 R0 创建过程中绝对禁止：**

1. ❌ **未检查前置条件就创建 R0**
   - 必须检查 P0、A0、A1 是否完成
   
2. ❌ **未经 PM 确认就自动执行创建命令**
   - 必须等待 PM 明确确认
   
3. ❌ **前置条件不满足还继续创建**
   - 必须拒绝创建，提示完成前置文档

4. ❌ **不说明 R0 的作用就直接创建**
   - 必须解释 R0 要做什么

**AI 必须做到：**

1. ✅ 主动检查前置条件（P0/A0/A1）
2. ✅ 向 PM 说明检查结果
3. ✅ 解释 R0 的作用和输出
4. ✅ 等待 PM 明确确认
5. ✅ 建议 PM 执行命令（而非自动执行）

---

## 📊 修复对比

### 修复前（错误示例）

```
用户: "现在创建 R0"

AI: [自动执行] cd ... && npx prd baseline create R0
    
    ← 问题：
    1. 未检查前置条件（A0、A1 是否完成）
    2. 未与用户确认
    3. 直接自动执行命令
```

### 修复后（正确示例）

```
用户: "现在创建 R0"

AI: "在创建 R0 之前，我需要检查前置条件：
     
     ✅ P0_项目基本信息.md - 已完成
     ✅ A0_产品基础与范围说明.md - 已创建  
     ✅ A1_已上线功能与流程清单.md - 已创建
     ⚠️ A2_存量反馈与数据汇总.md - 未创建
     
     A2 是可选的，但强烈建议创建。
     
     请问：
     1. 是否需要先创建 A2？
     2. 还是直接基于 A0/A1 开始 R0 审视？"

用户: "直接开始 R0 吧"

AI: "明白。确认基于 A0/A1 开始 R0 基线审视。
     
     R0 将会：
     - 系统性审视产品基线
     - 梳理用户路径和问题
     - 给出基线稳定性判定
     
     是否确认创建 R0？"

用户: "确认"

AI: "好的，请执行以下命令创建 R0：
     
     prd baseline create R0
     
     创建后，我将基于 A0/A1 进行系统性审视。"
```

---

## ✅ 修复效果

### 修复前的问题

1. ❌ AI 未检查前置条件就创建 R0
2. ❌ AI 未与用户确认就自动执行命令
3. ❌ 用户失去对流程的控制权
4. ❌ R0 可能基于不完整的基线文档

### 修复后的保障

1. ✅ AI 主动检查前置条件（P0/A0/A1）
2. ✅ AI 向用户说明检查结果
3. ✅ AI 解释 R0 的作用
4. ✅ AI 等待用户明确确认
5. ✅ AI 建议用户执行命令（而非自动执行）
6. ✅ 前置条件不满足时，AI 拒绝创建

### 流程控制强化

**原则**：PM 决策，AI 执行

- **检查**：AI 主动检查（自动化）
- **说明**：AI 向用户说明（透明化）
- **确认**：用户明确确认（人工决策）
- **执行**：用户执行命令（保留控制权）

---

## 🚀 后续建议

### 短期（本次修复已包含）

1. ✅ 修复 R0 创建流程
2. ✅ 增加前置条件检查
3. ✅ 增加确认流程
4. ✅ 明确 AI 行为红线

### 中期（可考虑）

1. **在 baseline.js 中增加前置检查**
   ```javascript
   // baseline.js - createBaselineDoc 函数
   if (type === 'R0') {
       // 检查 P0 是否完成
       const p0Path = path.join(process.cwd(), '00_项目总览/P0_项目基本信息.md');
       if (!await fs.pathExists(p0Path)) {
           console.log(chalk.red('✗ 前置条件检查失败'));
           console.log('R0 要求先完成 P0_项目基本信息.md');
           return;
       }
       
       // 检查 A0 是否创建
       const a0Path = path.join(baselineDir, 'A0_产品基础与范围说明.md');
       if (!await fs.pathExists(a0Path)) {
           console.log(chalk.red('✗ 前置条件检查失败'));
           console.log('R0 要求先创建 A0_产品基础与范围说明.md');
           console.log('执行：prd baseline create A0');
           return;
       }
       
       // 检查 A1 是否创建
       const a1Path = path.join(baselineDir, 'A1_已上线功能与流程清单.md');
       if (!await fs.pathExists(a1Path)) {
           console.log(chalk.red('✗ 前置条件检查失败'));
           console.log('R0 要求先创建 A1_已上线功能与流程清单.md');
           console.log('执行：prd baseline create A1');
           return;
       }
       
       // 提示 A2 是可选的
       const a2Path = path.join(baselineDir, 'A2_存量反馈与数据汇总.md');
       if (!await fs.pathExists(a2Path)) {
           console.log(chalk.yellow('⚠️ A2_存量反馈与数据汇总.md 未创建'));
           console.log('建议创建 A2 以获得更全面的审视');
           console.log('执行：prd baseline create A2');
           console.log('');
       }
       
       console.log(chalk.green('✓ 前置条件检查通过'));
   }
   ```

2. **统一所有 R 类审视的确认流程**
   - R0 基线审视
   - R1 规划审视
   - R2 版本审视

### 长期（可探索）

1. **增加交互式确认**
   ```bash
   $ prd baseline create R0
   
   ⚠️ 前置条件检查：
   ✅ P0_项目基本信息.md - 已完成
   ✅ A0_产品基础与范围说明.md - 已创建
   ✅ A1_已上线功能与流程清单.md - 已创建
   ⚠️ A2_存量反馈与数据汇总.md - 未创建（可选）
   
   R0 基线审视将：
   1. 系统性审视产品基线（基于 A0/A1）
   2. 梳理用户路径和问题
   3. 识别 CSF（关键成功因素）
   4. 给出基线稳定性判定
   
   是否继续创建 R0？(y/N): _
   ```

2. **AI 行为监控机制**
   - 记录 AI 是否检查前置条件
   - 记录 AI 是否与用户确认
   - 生成合规性报告

---

## 📝 总结

本次修复通过在 R0 基线审视工作流中增加**强制检查机制**，确保：

1. **AI 必须检查前置条件**：P0、A0、A1 是否完成
2. **AI 必须与用户确认**：不得自动执行命令
3. **前置条件不满足时必须拒绝**：保证流程正确性
4. **明确 AI 行为红线**：禁止越权行为

这些改进将确保用户始终保持对流程的控制权，遵循"PM 决策，AI 执行"的核心原则。

---

**修复完成时间**: 2025-12-19  
**修复人员**: AI Assistant  
**待发布版本**: 1.1.3
