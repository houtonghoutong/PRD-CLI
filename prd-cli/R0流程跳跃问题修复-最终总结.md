# R0 流程跳跃问题修复 - 最终总结

**修复时间**: 2025-12-22  
**版本**: 1.1.7 → 1.1.8  
**修复状态**: ✅ 已完成  

---

## 🎯 问题本质

用户反馈：**AI 在聊完 R0 后，直接创建了 R1 并且评审通过**

这是一个严重的流程跳跃问题，AI 跳过了整个规划阶段。

---

## 🔍 关键发现：有两个 R1 文档！

在分析过程中发现，PRD-CLI 系统中实际存在**两个不同的 R1 文档**，它们的作用完全不同：

| 文档 | 生成命令 | 作用 | 位置 | 填写时机 |
|-----|----------|------|------|---------|
| **R1_规划启动条件检查.md** | `prd iteration new` 自动创建 | 确认是否**允许进入**规划阶段 | B1/B2 **之前** | 创建迭代后 |
| **R1_规划审视报告.md** | `prd review r1` 创建 | 判断规划是否**有资格冻结**为 B3 | B1/B2 **之后** | B1/B2 完成后 |

### 正确的完整流程

```
R0 (基线审视) 完成
  ↓
  [AI 停止，等待 PM 决定]
  ↓
PM: prd iteration new
  ↓
自动生成: R1_规划启动条件检查.md  ← 第1个R1
  ↓
PM 填写 & 确认 3 个启动条件
  ↓
  [条件满足]
  ↓
PM: prd plan create B1
  ↓
PM 与 AI 对话填写 B1
  ↓
PM: prd plan create B2
  ↓
PM 与 AI 对话填写 B2
  ↓
PM: prd review r1
  ↓
自动生成: R1_规划审视报告.md  ← 第2个R1
  ↓
AI 审视 B1/B2
  ↓
  [审视通过]
  ↓
PM: prd plan freeze
  ↓
生成 B3_规划冻结归档.md
```

---

## ✅ 修复方案

### 1. 强化 R0 工作流结束边界

**文件**: `.agent/workflows/prd-r0-baseline-review.md`

**核心修改**:
- ✅ 明确禁止 R0 完成后自动创建任何后续文档
- ✅ 禁止在 R0 阶段提及 "R1"（避免混淆）
- ✅ 增加完整的 5 步操作指引，包括：
  - 第 1 步：创建迭代（自动生成 R1_规划启动条件检查.md）
  - 第 2 步：**填写并确认 R1 启动条件**（新增说明）
  - 第 3 步：创建 B1
  - 第 4 步：创建 B2
  - 第 5 步：请求 R1 审视（生成 R1_规划审视报告.md）

**删除的误导性表述**:
```markdown
❌ "如果要基于此规划，请允许我进入 R1 启动条件检查"
```

**新增的清晰指引**:
```markdown
✅ "第 1 步：创建第一轮迭代
    命令：prd iteration new
    （这会自动生成 R1_规划启动条件检查.md）
    
    第 2 步：填写并确认 R1 启动条件
    打开 R1_规划启动条件检查.md，确认 3 个条件：
    1. 问题真实存在（在 A1/A2 中有依据）
    2. 值得单独规划（不是小修小补）
    3. 问题已理解清楚（边界明确）
    ⚠️ 任何一条不满足，不要继续！"
```

### 2. 明确 R1 审视工作流的定位

**文件**: `.agent/workflows/prd-r1-review.md`

**核心修改**:
- ✅ 在开头明确说明：本工作流是 **R1 规划审视**，不是 **R1 启动条件检查**
- ✅ 清晰区分两个 R1 文档的位置和作用
- ✅ 保留前置检查机制（R1 审视确实需要 B1/B2 存在）

**新增说明**:
```markdown
**重要说明**：本工作流是关于 **R1 规划审视**（在 B1/B2 之后），
不是 **R1 启动条件检查**（在 B1/B2 之前）。

- **R1 启动条件检查**：在 `prd iteration new` 时自动创建，
  用于确认是否允许进入规划阶段（B1/B2 之前）
- **R1 规划审视**：在 `prd review r1` 时创建，
  用于判断规划是否有资格冻结为 B3（B1/B2 之后）
```

### 3. 更新 .cursorrules

**文件**: `.cursorrules`

**核心修改**:
- ✅ 详细列出前置条件（9项）
- ✅ 新增 "禁止流程跳跃" 专门章节
- ✅ 定义每个阶段的结束点

### 4. 更新版本信息

- ✅ `package.json`: 1.1.7 → 1.1.8
- ✅ `CHANGELOG.md`: 详细记录本次修复

---

## 📊 修复效果对比

### 场景：R0 完成后

**修复前（错误）**:
```
PM: "R0 完成了"
AI: "好的，我帮你进入 R1..."  ← ❌ 混淆了两个R1
    或
    "我现在执行 R1 审视..."  ← ❌ 跳过了中间步骤
```

**修复后（正确）**:
```
PM: "R0 完成了"
AI: "✅ R0 基线审视已完成。
     
     ⚠️ 我的职责到此为止，不会自动执行任何后续操作。
     
     下一步完全由您决定：
     
     第 1 步：创建第一轮迭代
     命令：prd iteration new
     （这会自动生成 R1_规划启动条件检查.md）
     
     第 2 步：填写并确认 R1 启动条件
     打开 R1_规划启动条件检查.md，确认 3 个条件...
     
     第 3 步：创建 B1 需求规划草案...
     第 4 步：创建 B2 规划拆解...
     第 5 步：请求 R1 规划审视..."
     
     ← ✅ 清晰列出完整步骤，明确区分两个R1
```

---

## 🎯 核心价值

### 1. 流程完整性 ✅
- 不会跳过任何必要步骤
- 明确区分两个 R1 文档的位置和作用

### 2. PM 控制权 ✅
- AI 不会自动推进流程
- 每个决策点都需要 PM 明确指令

### 3. 概念清晰性 ✅
- 明确区分 "R1 启动条件检查" 和 "R1 规划审视"
- 避免因名称相似导致的混淆
- 在关键位置增加说明，防止误解

### 4. 决策透明性 ✅
- 每个阶段的后续步骤清晰明确
- AI 的检查过程可见
- 用户知道每一步在做什么

---

## 📦 修改文件清单

| 文件 | 主要修改 | 重要性 |
|-----|---------|--------|
| `.agent/workflows/prd-r0-baseline-review.md` | 强化结束边界，增加5步详细指引 | 🔴 关键 |
| `.agent/workflows/prd-r1-review.md` | 明确定位，区分两个R1文档 | 🔴 关键 |
| `.cursorrules` | 增加流程跳跃禁止规则 | 🟠 重要 |
| `package.json` | 版本号 1.1.7 → 1.1.8 | 🟢 常规 |
| `CHANGELOG.md` | 详细记录本次修复 | 🟢 常规 |
| `R0流程跳跃问题修复说明.md` | 详细分析和修复说明 | 🟡 参考 |

---

## ✅ 验证清单

| 验证项 | 状态 | 说明 |
|--------|-----|------|
| R0 完成后不自动创建后续文档 | ✅ 通过 | 修改了工作流话术 |
| R0 完成后不提及 "R1" | ✅ 通过 | 删除了误导性表述 |
| 明确列出完整的5步流程 | ✅ 通过 | 增加了详细指引 |
| 说明 R1 启动条件检查 | ✅ 通过 | 第2步明确说明 |
| 区分两个 R1 文档 | ✅ 通过 | 在多处增加说明 |
| R1 审视前检查 B1/B2 存在 | ✅ 保持 | 前置检查机制保留 |
| .cursorrules 包含流程规则 | ✅ 通过 | 新增专门章节 |
| 版本号已更新 | ✅ 通过 | 1.1.7 → 1.1.8 |
| CHANGELOG 已更新 | ✅ 通过 | 详细记录修复 |

---

## 📝 待测试场景

建议测试以下场景以验证修复效果：

### 场景 1：正常流程
1. 完成 R0
2. AI 应该停止并列出 5 步指引
3. 执行 `prd iteration new`
4. 查看是否生成 `R1_规划启动条件检查.md`
5. 填写启动条件
6. 创建 B1、B2
7. 执行 `prd review r1`
8. 查看是否生成 `R1_规划审视报告.md`

### 场景 2：异常阻止
1. 完成 R0
2. 用户直接说 "执行 R1 审视"
3. AI 应该检查前置条件
4. 如果 B1/B2 不存在，应该拒绝并说明原因

---

## 🚀 发布准备

### 打包命令
```bash
cd /Users/hou/Documents/UGit/PRD-CLI/prd-cli
npm pack
```

### 生成文件
`prd-workflow-cli-1.1.8.tgz`

### 安装命令
```bash
npm install -g prd-workflow-cli-1.1.8.tgz
```

---

**修复完成时间**: 2025-12-22  
**修复人员**: AI Assistant  
**发布版本**: 1.1.8  
**修复状态**: ✅ 已完成，建议测试验证

---

## 💡 关键经验教训

1. **名称相似性风险**: 两个 "R1" 文档容易混淆，需要在多处明确说明
2. **流程边界重要性**: 每个阶段结束后 AI 必须明确停止
3. **步骤展示完整性**: 不能只说 "下一步做X"，要列出后续的完整路径
4. **概念区分必要性**: 相似概念需要在关键位置反复说明，避免误解
