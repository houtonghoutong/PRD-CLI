# R0-R1 流程跳跃问题分析与修复方案

**问题发现时间**: 2025-12-22  
**版本**: 1.1.7  
**问题严重程度**: 🔴 严重（流程跳跃）  

---

## 🚨 问题描述

### 用户反馈

在 1.1.7 版本中，AI 在完成 R0 基线审视后，**直接创建了 R1 并且评审通过**，跳过了正确的流程：

**正确流程应该是：**
```
R0 (基线审视) → 
PM 决定是否开始迭代 → 
创建第一轮迭代 (prd iteration new) →
创建 B1 规划草案 →
创建 B2 规划拆解 →
PM 确认完成 →
执行 R1 规划审视 →
PM 决定是否冻结
```

**实际发生的（错误）：**
```
R0 (基线审视) →
[AI 自动跳跃] →
直接创建并通过 R1
```

### 问题的严重性

这是一个**严重的流程控制问题**，因为：

1. **跳过了必要的规划阶段**
   - 没有创建迭代
   - 没有创建 B1（需求规划草案）
   - 没有创建 B2（规划拆解）

2. **违反了 PM 决策权**
   - PM 没有决定是否要开始迭代
   - PM 没有填写 B1/B2 内容
   - PM 没有请求 R1 审视

3. **破坏了文档依赖关系**
   - R1 必须审视 B1/B2，但这些文档根本不存在
   - 无法进行有效的规划审视

---

## 🔍 根因分析

### 问题根源 1：R0 工作流缺少明确的边界

查看 `.agent/workflows/prd-r0-baseline-review.md` 第 260-271 行：

```markdown
1. ❌ **不得将 R0 直接转化为 B 类规划**
   错误示例：
   AI: "R0 发现了问题，我现在帮你创建 B1 规划..."
   ← 越权了！除非 PM 明确指令进入 R1
   
   正确做法：
   AI: "R0 审视已完成。
        下一步由 PM 决定：
        - 如果要基于此规划，请允许我进入 R1 启动条件检查
        - 如果要先解决问题，请先修复后重新 R0"
```

**问题**：虽然有红线说明，但：
1. ❌ 没有明确禁止 "创建 R1"
2. ❌ "进入 R1 启动条件检查" 这个表述容易产生歧义
3. ❌ 没有明确要求 AI 必须等待 PM 创建迭代和 B1/B2

### 问题根源 2：R0 后续流程指引不准确

查看 `.agent/workflows/prd-r0-baseline-review.md` 第 758-776 行：

```markdown
AI: "R0 基线审视已完成。
     
     结论：[稳定基线 / 需先解决问题 / 不适合]
     
     下一步：
     1. 如果是'稳定基线' → 可以开始第一轮迭代
        运行：prd iteration new
     
     2. 如果是'需先解决问题' → 先解决阻断性问题
        ...
     
     请问您要如何处理？"
```

**问题**：
1. ✅ 正确指出了下一步是 `prd iteration new` 
2. ❌ 但没有明确禁止跳过这一步
3. ❌ 没有明确说明 R1 的前置条件

### 问题根源 3：R1 工作流缺少前置检查

查看 `.agent/workflows/prd-r1-review.md`，发现：

**存在的检查**（第 30-50 行）：
- ✅ 检查 B1/B2 是否通过对话完成
- ✅ 检查 PM 是否做了决策

**缺失的检查**：
- ❌ 没有检查"是否创建了迭代"
- ❌ 没有检查"是否存在 B1/B2 文件"
- ❌ 没有检查"PM 是否明确请求 R1 审视"

**最关键的问题**：AI 可以在 B1/B2 文件不存在的情况下被触发创建 R1！

### 问题根源 4：AI 可能误解了"进入R1启动条件检查"

R0 工作流说："请允许我进入 R1 启动条件检查"，AI 可能理解为：
- ❌ 错误理解："帮 PM 检查条件，然后自动创建 R1"
- ✅ 正确理解："等 PM 完成 B1/B2 后，PM 再请求 R1 审视"

---

## 🔧 修复方案

### 修复 1：强化 R0 工作流的结束边界

**位置**：`.agent/workflows/prd-r0-baseline-review.md`

**修改第 254-284 行**（AI 绝对禁止部分），增强表述：

```markdown
### AI 绝对禁止

**红线（AI 不得越界）**：

1. ❌ **R0 完成后，禁止创建任何后续文档**
   ```
   错误示例：
   AI: "R0 发现了问题，我现在帮你创建 B1 规划..."
   AI: "R0 完成，我帮你创建第一轮迭代..."
   AI: "R0 完成，我现在执行 R1 审视..."
   ← 全部越权！
   
   正确做法：
   AI: "R0 基线审视已完成。
        
        ⚠️ 我的工作在此结束，不会自动创建任何后续文档。
        
        下一步完全由 PM 决定：
        
        【选项 1】如果基线稳定，开始第一轮迭代：
        1. PM 执行：prd iteration new （创建第一轮迭代）
        2. PM 执行：prd baseline create B1 （创建规划草案）
        3. PM 与 AI 对话填写 B1
        4. PM 执行：prd baseline create B2 （创建规划拆解）
        5. PM 与 AI 对话填写 B2
        6. PM 执行：prd review r1 （请求 R1 审视）
        
        【选项 2】如果需要先解决问题：
        - 在当前系统修复问题
        - 修复后更新 A1
        - 重新执行 R0
        
        请问您选择哪个选项？"
   ```

2. ❌ **R0 完成后，禁止主动提及"R1"**
   ```
   错误示例：
   AI: "如果要基于此规划，请允许我进入 R1 启动条件检查"
   ← 容易误导！不应该在 R0 阶段提及 R1
   
   正确做法：
   AI: "下一步请创建第一轮迭代：prd iteration new"
   ← 只说明紧接着的下一步，不要跳跃
   ```

3. ❌ **不得替 PM 判定"必须做/不做"**
   （原有内容保持不变）
```

### 修复 2：强化 R0 后续流程指引

**位置**：`.agent/workflows/prd-r0-baseline-review.md`

**修改第 754-777 行**（后续流程部分）：

```markdown
## 🔄 R0 完成后的正确流程

### ⚠️ 重要：R0 是一个独立的审视阶段

**R0 完成后，AI 的职责结束，不得继续任何操作！**

### R0 完成时的标准话术

```
AI: "✅ R0 基线审视已完成。
     
     📊 审视结论：[稳定基线 / 需先解决问题 / 不适合]
     
     ⚠️ 我的职责到此为止，不会自动执行任何后续操作。
     
     下一步完全由您决定：
     
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     
     【情况 1】如果审视结论是"稳定基线"：
     
     您可以开始第一轮迭代，请按以下顺序操作：
     
     第 1 步：创建第一轮迭代
     命令：prd iteration new
     
     第 2 步：创建 B1 需求规划草案
     命令：prd baseline create B1
     然后与我对话填写 B1
     
     第 3 步：创建 B2 规划拆解
     命令：prd baseline create B2
     然后与我对话填写 B2
     
     第 4 步：请求 R1 规划审视
     命令：prd review r1
     我将审视 B1/B2 是否有资格冻结
     
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     
     【情况 2】如果审视结论是"需先解决问题"：
     
     请先修复关键问题：
     1. 在当前系统中修复问题
     2. 修复后更新 A1_已上线功能与流程清单.md
     3. 重新执行 R0：prd baseline create R0
     
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     
     【情况 3】如果审视结论是"不适合作为基线"：
     
     产品可能需要重构，请评估：
     - 重构成本和收益
     - 是否值得投入
     - 还是考虑重新设计
     
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     
     请问您要如何处理？"
```

### ⚠️ AI 行为红线（R0 完成后）

**AI 绝对禁止：**

1. ❌ 自动创建第一轮迭代
2. ❌ 自动创建 B1/B2
3. ❌ 自动执行 R1 审视
4. ❌ 在 PM 未明确请求时，主动提及 R1
5. ❌ 说"我现在帮你进入下一阶段"

**AI 必须做到：**

1. ✅ 只输出 R0 审视结论
2. ✅ 清晰列出后续步骤（由 PM 执行）
3. ✅ 等待 PM 明确指令
4. ✅ PM 说"创建迭代"才能响应
5. ✅ PM 说"创建 B1"才能响应
6. ✅ PM 说"执行 R1"才能响应
```

### 修复 3：强化 R1 工作流的前置检查

**位置**：`.agent/workflows/prd-r1-review.md`

**在第 5 行后增加新章节**：

```markdown
---

## 🚨 重要：R1 创建前的强制检查

### ⚠️ AI 绝对禁止在以下情况创建 R1

**当 PM 提出"创建 R1"或"执行 R1 审视"时，AI 必须先检查：**

#### 检查清单（AI 必须执行）

```
AI: "在执行 R1 审视之前，我需要检查前置条件：
     
     ✅ 前置条件检查：
     
     第 1 项：是否已创建第一轮迭代？
     检查目录：02_迭代记录/第01轮迭代/
     状态：[✅ 已创建 / ❌ 未创建]
     
     第 2 项：B1_需求规划草案.md 是否存在？
     检查路径：02_迭代记录/第01轮迭代/B1_需求规划草案.md
     状态：[✅ 已创建 / ❌ 未创建]
     
     第 3 项：B2_规划拆解与范围界定.md 是否存在？
     检查路径：02_迭代记录/第01轮迭代/B2_规划拆解与范围界定.md
     状态：[✅ 已创建 / ❌ 未创建]
     
     第 4 项：B1/B2 是否通过对话完成？
     - B1 的核心问题是和 PM 讨论后确定的吗？
     - B2 的需求拆解是和 PM 讨论后确定的吗？
     - 优先级（P0/P1/P2）是 PM 决定的吗？
     状态：[✅ 是 / ❌ 否 / ⚠️ 不确定]
     
     第 5 项：PM 是否明确请求 R1 审视？
     状态：[✅ 明确请求 / ❌ 我没有收到请求]
     
     检查结果：[✅ 全部通过 / ❌ 有未满足项]"
```

#### 前置条件不满足时的处理

**如果任何一项未满足，AI 必须拒绝创建 R1：**

```
AI: "❌ 前置条件检查未通过！
     
     R1 规划审视的前置条件：
     
     必须项：
     - [❌] 第一轮迭代已创建
     - [❌] B1_需求规划草案.md 已创建
     - [❌] B2_规划拆解与范围界定.md 已创建
     - [❌] B1/B2 已通过对话完成（不是 AI 自动填充）
     - [❌] PM 明确请求了 R1 审视
     
     ⚠️ R1 审视不能凭空进行，必须基于 B1/B2 文档。
     
     正确的流程应该是：
     
     1. 创建第一轮迭代：prd iteration new
     2. 创建 B1：prd baseline create B1
     3. 与 AI 对话填写 B1
     4. 创建 B2：prd baseline create B2
     5. 与 AI 对话填写 B2
     6. 请求 R1 审视：prd review r1
     
     ⚠️ 我已拒绝创建 R1，请完成前置步骤后重试。"
```

#### 前置条件满足时的确认流程

**如果所有前置条件都满足：**

```
AI: "✅ 前置条件检查通过！
     
     已确认：
     ✅ 第一轮迭代已创建
     ✅ B1_需求规划草案.md 已创建
     ✅ B2_规划拆解与范围界定.md 已创建
     ✅ B1/B2 已通过对话完成
     ✅ 您明确请求了 R1 审视
     
     现在可以开始 R1 规划审视。
     
     R1 审视将：
     1. 检查目标清晰性（区分手段与目标）
     2. 检查场景真实性（基于现状）
     3. 检查现状一致性（改进 vs 重建）
     4. 检查范围收敛性（MECE 原则）
     5. 检查版本化准备度（CSF 识别）
     
     请执行命令创建 R1 审视报告：
     
     prd review r1
     
     创建后，我将基于 B1/B2 进行系统性审视。"
```

### ⚠️ AI 行为红线（R1 创建）

**AI 在 R1 创建过程中绝对禁止：**

1. ❌ **未检查前置条件就创建 R1**
   - 必须检查迭代、B1、B2 是否存在
   
2. ❌ **B1/B2 不存在还继续创建 R1**
   - 无文档无法审视，必须拒绝
   
3. ❌ **从 R0 直接跳到 R1**
   - 必须先经过：迭代创建 → B1 → B2 → R1
   
4. ❌ **PM 没有明确请求就自动创建 R1**
   - 必须等待 PM 明确指令

**AI 必须做到：**

1. ✅ 主动检查前置条件（迭代/B1/B2）
2. ✅ 向 PM 说明检查结果
3. ✅ 前置条件不满足时，明确拒绝并说明原因
4. ✅ 等待 PM 明确请求
5. ✅ 只 建议 PM 执行命令（而非自动执行）

---
```

### 修复 4：更新 .cursorrules

**位置**：`.cursorrules`

**在第 100 行后增加**：

```markdown
### 1. 检查前置条件

创建任何文档前，先检查：
- R0 需要 P0/A0/A1 完成
- 第一轮迭代需要 R0 完成且 PM 决定开始
- B1 需要第一轮迭代已创建
- B2 需要 B1 完成
- R1 需要 B1/B2 完成且通过对话填写
- B3 需要 R1 审视通过
- C0/C1 需要 B3 冻结

### ⚠️ 禁止流程跳跃

**绝对禁止的跳跃行为：**
- ❌ R0 完成后直接创建 R1（必须先：迭代→B1→B2→R1）
- ❌ R0 完成后直接创建 B1（必须先：迭代→B1）
- ❌ B1 完成后直接创建 R1（必须先：B2→R1）
- ❌ 任何未经 PM 明确请求的文档创建

**每个阶段的结束点：**
- R0 完成 → AI 停止，等待 PM 决定
- B1 完成 → AI 停止，等待 PM 请求 B2
- B2 完成 → AI 停止，等待 PM 请求 R1
- R1 完成 → AI 停止，等待 PM 决定冻结
```

---

## 📊 修复效果对比

### 修复前（错误流程）

```
R0 完成
  ↓
AI: "R0 完成，我帮你进入 R1..."  ← ❌ 自动跳跃
  ↓
创建 R1（B1/B2 不存在）  ← ❌ 凭空审视
  ↓
给出审视结论  ← ❌ 无效结论
```

### 修复后（正确流程）

```
R0 完成
  ↓
AI: "R0 完成。
     下一步完全由您决定：
     1. 创建迭代：prd iteration new
     2. 创建 B1：...
     ..."
  ↓ [AI 停止，等待 PM 决策]
  ↓
PM: "创建第一轮迭代"
  ↓
AI: [执行 prd iteration new]
  ↓
PM: "创建 B1"
  ↓
AI: [通过对话填写 B1]
  ↓
PM: "创建 B2"
  ↓
AI: [通过对话填写 B2]
  ↓
PM: "执行 R1 审视"
  ↓
AI: [检查前置条件]
  ├─ ❌ 不满足 → 拒绝并说明原因
  └─ ✅ 满足 → 执行 R1 审视
```

---

## ✅ 验证清单

修复完成后，需要验证以下场景：

### 场景 1：R0 完成后

- [ ] AI 不会自动创建任何后续文档
- [ ] AI 清晰列出后续步骤（由 PM 执行）
- [ ] AI 不会主动提及 "R1"
- [ ] AI 等待 PM 明确指令

### 场景 2：PM 直接说"创建 R1"（在 B1/B2 不存在时）

- [ ] AI 检查前置条件
- [ ] AI 发现 B1/B2 不存在
- [ ] AI 明确拒绝创建 R1
- [ ] AI 说明正确的流程

### 场景 3：PM 按正确流程操作

- [ ] 创建迭代 → 创建 B1 → 创建 B2 → 请求 R1
- [ ] AI 检查前置条件通过
- [ ] AI 正确执行 R1 审视

---

## 🚀 实施步骤

1. ✅ **修改 R0 工作流**
   - 强化结束边界
   - 禁止提及 R1
   - 明确后续步骤

2. ✅ **修改 R1 工作流**
   - 增加前置检查章节
   - 必须检查迭代/B1/B2
   - 不满足时拒绝创建

3. ✅ **更新 .cursorrules**
   - 增加流程跳跃禁止规则
   - 明确每个阶段的结束点

4. ⚠️ **更新版本号**
   - 1.1.7 → 1.1.8（建议）

5. ⚠️ **测试验证**
   - 按验证清单测试所有场景

6. ⚠️ **更新 CHANGELOG**
   - 记录此次修复

---

## 📝 总结

本次问题的核心在于：

1. **R0 工作流缺少明确的结束边界**
   - 允许 AI "进入 R1 启动条件检查"（产生歧义）
   - 没有明确禁止跳跃到 R1

2. **R1 工作流缺少前置检查**
   - 没有检查 B1/B2 是否存在
   - 没有检查是否创建了迭代

3. **AI 的越权行为**
   - 自动执行了用户未请求的操作
   - 跳过了必要的中间步骤

修复方案通过：
- ✅ 强化 R0 结束边界（禁止自动进入下一阶段）
- ✅ 增加 R1 前置检查（必须有 B1/B2）
- ✅ 明确 AI 行为红线（禁止流程跳跃）

确保"PM 决策，AI 执行"的核心原则得到严格遵守。

---

**修复方案制定时间**: 2025-12-22  
**修复人员**: AI Assistant  
**待发布版本**: 1.1.8
