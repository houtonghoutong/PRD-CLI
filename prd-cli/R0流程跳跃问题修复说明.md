# R0 流程跳跃问题修复说明

**修复时间**: 2025-12-22  
**版本**:1.1.7 → 1.1.8  
**问题严重级别**: 🔴 严重（流程控制）  

---

## 📌 问题描述

用户在使用 1.1.7 版本时发现：**AI 在聊完 R0 后，直接创建了 R1 并且评审通过**。

这是严重的流程跳跃问题。

---

## 🎯 正确的完整流程

### 流程图

```
R0 (基线审视) 完成
  ↓
  [AI 停止，等待 PM 决定]
  ↓
PM 执行：prd iteration new (创建第一轮迭代)
  ↓
自动生成：R1_规划启动条件检查.md  ← 这是第一个R1文档
  ↓
PM 填写并确认 3 个启动条件
  ↓
  [条件通过，允许进入规划]
  ↓
PM 执行：prd plan create B1 (创建规划草案)
  ↓
PM 与 AI 对话填写 B1
  ↓
PM 执行：prd plan create B2 (创建规划拆解)
  ↓
PM 与 AI 对话填写 B2
  ↓
PM 执行：prd review r1 (执行规划审视)
  ↓
自动生成：R1_规划审视报告.md  ← 这是第二个R1文档
  ↓
AI 审视 B1/B2 是否有资格冻结
  ↓
  [审视通过]
  ↓
PM 执行：prd plan freeze (冻结为 B3)
```

### 关键理解：有两个不同的 R1 文档

| 文档名 | 生成时机 | 作用 | 位置 |
|--------|---------|------|------|
| `R1_规划启动条件检查.md` | `prd iteration new` 时自动创建 | 确认是否**允许进入**规划阶段（B1/B2） | **B1/B2 之前** |
| `R1_规划审视报告.md` | `prd review r1` 时创建 | 判断规划是否**有资格冻结**为 B3 | **B1/B2 之后** |

---

## ❌ 问题分析

### 用户遇到的错误流程

```
R0 完成
  ↓
AI 自动跳跃：直接创建 R1_规划审视报告.md  ← ❌ 错误
  ↓
AI 自动审视并通过  ← ❌ 根本没有 B1/B2 可审
```

### 问题根源

1. **R0 工作流缺少明确的结束边界**
   - 没有明确禁止 R0 完成后自动创建后续文档
   - 存在容易误导的表述

2. **两个 R1 文档容易混淆**
   - 用户说的"直接创建了R1"，可能AI理解错了是哪个R1
   - 工作流文档没有明确区分两个R1的位置和作用

---

## ✅ 修复内容

### 修复 1：强化 R0 工作流结束边界

**文件**: `.agent/workflows/prd-r0-baseline-review.md`

**修复内容**:
1. 明确禁止 R0 完成后自动创建任何后续文档
2. 禁止在 R0 阶段提及 "R1"（容易混淆）
3. 明确列出完整的后续步骤序列
4. 增加 "AI 行为红线（R0 完成后）" 章节

**关键修改**：

删除了容易误导的表述：
```markdown
❌ 旧版本：
"如果要基于此规划，请允许我进入 R1 启动条件检查"
```

改为明确的步骤列表：
```markdown
✅ 新版本：
"下一步完全由您决定：

第 1 步：创建第一轮迭代
命令：prd iteration new
（这会自动生成 R1_规划启动条件检查.md）

第 2 步：填写并确认 R1 启动条件
确认 3 个条件是否满足

第 3 步：创建 B1 需求规划草案
命令：prd plan create B1
然后与我对话填写 B1

第 4 步：创建 B2 规划拆解
命令：prd plan create B2
然后与我对话填写 B2

第 5 步：请求 R1 规划审视
命令：prd review r1
我将审视 B1/B2 是否有资格冻结"
```

### 修复 2：明确 R1 审视工作流的定位

**文件**: `.agent/workflows/prd-r1-review.md`

**修复内容**:
1. 在开头明确说明：本工作流是关于 **R1 规划审视**，不是 **R1 启动条件检查**
2. 清晰区分两个 R1 文档的位置和作用
3. 保留前置检查机制（因为 R1 审视确实需要 B1/B2 存在）

**关键说明**：

```markdown
**重要说明**：本工作流是关于 **R1 规划审视**（在 B1/B2 之后），不是 **R1 启动条件检查**（在 B1/B2 之前）。

- **R1 启动条件检查**：在 `prd iteration new` 时自动创建，用于确认是否允许进入规划阶段（B1/B2 之前）
- **R1 规划审视**：在 `prd review r1` 时创建，用于判断规划是否有资格冻结为 B3（B1/B2 之后）
```

### 修复 3：更新 .cursorrules

**文件**: `.cursorrules`

**修复内容**:
1. 增加详细的前置条件说明
2. 明确禁止流程跳跃行为
3. 定义每个阶段的结束点

### 修复 4：更新版本

- `package.json`: 1.1.7 → 1.1.8
- `CHANGELOG.md`: 详细记录本次修复

---

## 🎯 修复效果

### 场景 1：R0 完成后

**之前（错误）**：
```
PM: "R0 完成了"
AI: "好的，我帮你进入 R1 启动条件检查..."  ← ❌ 表述模糊
或
AI: "好的，我现在执行 R1 审视..."  ← ❌ 直接跳跃
```

**现在（正确）**：
```
PM: "R0 完成了"
AI: "✅ R0 基线审视已完成。
     
     ⚠️ 我的职责到此为止，不会自动执行任何后续操作。
     
     下一步完全由您决定：
     
     第 1 步：创建第一轮迭代
     命令：prd iteration new
     （这会自动生成 R1_规划启动条件检查.md）
     ..."
```

### 场景 2：PM 直接说"执行 R1"

**之前（可能混淆）**：
```
PM: "执行 R1"
AI: [不确定是哪个R1，可能执行错误的]
```

**现在（明确检查）**：
```
PM: "执行 R1 审视"  ← PM 需要明确说明
AI: "在执行 R1 规划审视之前，我需要检查前置条件：
     
     ✅ 第一轮迭代已创建
     ✅ B1_需求规划草案.md 已创建
     ✅ B2_规划拆解与范围界定.md 已创建
     
     前置条件检查通过，开始 R1 审视..."
```

---

## 📦 修改文件清单

| 文件 | 修改内容 | 重要性 |
|-----|---------|--------|
| `.agent/workflows/prd-r0-baseline-review.md` | 强化结束边界，列出完整步骤 | 🔴 关键 |
| `.agent/workflows/prd-r1-review.md` | 明确定位，区分两个R1 | 🔴 关键 |
| `.cursorrules` | 增加流程跳跃禁止规则 | 🟠 重要 |
| `package.json` | 版本号升级 | 🟢 常规 |
| `CHANGELOG.md` | 记录修复 | 🟢 常规 |

---

## ✅ 核心价值

1. **流程完整性** ✅
   - 不会跳过任何必要步骤
   - 明确区分两个 R1 文档的位置

2. **PM 控制权** ✅
   - AI 不会自动推进流程
   - 每个决策点都需要 PM 明确指令

3. **概念清晰性** ✅
   - 明确区分 "R1 启动条件检查" 和 "R1 规划审视"
   - 避免因名称相似导致的混淆

4. **决策透明性** ✅
   - 每个阶段的后续步骤清晰明确
   - AI 的检查过程可见

---

**修复完成时间**: 2025-12-22  
**修复人员**: AI Assistant  
**发布版本**: 1.1.8
