# 对话归档机制修复方案

**问题时间**: 2025-12-19  
**问题描述**: 对话归档目录为空，PM 和 AI 在 IDE 中的对话没有被记录

---

## 📌 问题分析

### 当前情况

1. **有归档代码**：`dialog.js` 提供了完整的归档函数
2. **有归档目录**：项目会创建 `98_对话归档/` 目录
3. **但是为空**：实际使用时，对话没有被记录

### 根本原因

**问题**：对话归档只能通过 **主动调用** 实现，但：

- ❌ CLI 命令只记录命令执行的确认
- ❌ AI 在 IDE 中与 PM 对话时，**无法自动调用归档函数**
- ❌ 没有强制要求 AI 归档对话

### 用户期望

用户明确指出：
> "归档的内容是 PM 和 AI 聊的内容，不光是命令行的对话"

这意味着归档应该包括：
- ✅ P和 AI 在 IDE 中的对话
- ✅ AI 提出的问题和建议
- ✅ PM 的回答和决策
- ✅ 讨论过程（不只是结论）

---

## ❌ 当前实现的局限性

### 局限 1：AI 无法直接调用 Node.js 函数

AI 在 IDE 中与 PM 对话时：
- 无法执行 `require('dialog.js')`
- 无法调用 `logConversationRound()`
- 只能通过文件读写操作

### 局限 2：缺少归档提示

工作流文档（如 B1/B2）中：
- ❌ 没有强制要求 AI 归档对话
- ❌ 没有说明如何归档
- ❌ 没有归档检查点

### 局限 3：归档方法太复杂

`dialog.js` 提供的方法虽然完整，但：
- 需要在项目目录执行 Node.js 代码
- AI 无法直接使用
- 太依赖 CLI 环境

---

## ✅ 解决方案

### 方案 1：AI 直接写入 Markdown 格式

**核心思路**：AI 在对话过程中，直接写入 `98_对话归档/` 目录下的 Markdown 文件

#### 优点
- ✅ AI 可以直接使用 `write_to_file` 工具
- ✅ 不依赖 CLI 环境
- ✅ 格式简单，人类可读

#### 实现方式

**文件路径规则**：
```
98_对话归档/
├── P0_对话记录.md            # P0 填写时的对话
├── A0_对话记录.md            # A0 填写时的对话
├── R0_对话记录.md            # R0 审视时的对话
└── 第01轮迭代/
    ├── B1_对话记录.md        # B1 填写时的对话
    ├── B2_对话记录.md        # B2 填写时的对话
    ├── R1_对话记录.md        # R1 审视时的对话
    ├── C1_对话记录.md        # C1 填写时的对话
    └── R2_对话记录.md        # R2 审视时的对话
```

**Markdown 格式模板**：

```markdown
# B1 需求规划草案 - 对话记录

**创建时间**: 2025-12-19 14:45:00
**迭代轮次**: 第 01 轮迭代

---

## 💬 对话 #1

**时间**: 2025-12-19 14:50:00  
**讨论主题**: 明确规划目标

### 🤖 AI 提问
> 你期望这个规划达成什么结果？（End Game）
> 
> 请用一句话描述，并且这个结果必须是可衡量的。

### 🧑 PM 回答
> 我想提升内审流程的效率

### 🤖 AI 引导
> "提升内审流程效率"是手段。真正要达成的结果是什么？
> 
> 比如：
> - 是缩短内审时间？
> - 是提高通过率？
> - 是减少返工次数？
> 
> 请具体说明。

### 🧑 PM 澄清
> 缩短内审时间，从现在的平均 14 天缩短到 10 天

### 🤖 AI 总结
> 明白了。所以核心目标是：
> 
> **"将内审流程时间从平均 14 天缩短到 10 天"**
> 
> 这个 Gap（差距）在 A2 用户反馈中有体现吗？

### ✅ PM 确认
> 有的，A2 中用户反馈审批太慢

### 📝 AI 记录
> 已将此目标写入 B1 的"规划目标"章节。

---

## 💬 对话 #2

**时间**: 2025-12-19 15:00:00  
**讨论主题**: 明确"不做什么"

### 🤖 AI 提问
> 现在我们明确了要做什么。同样重要的是：
> 
> 什么是明确不做的？
> 
> 请列举至少 3 个本轮规划明确不包含的内容。

### 🧑 PM 回答
> 不做 AI 自动建议、不做商业业务闭环、不做数据分析看板

### 🤖 AI 确认
> 好的，本轮明确不做：
> 1. AI 自动建议
> 2. 商业业务闭环
> 3. 数据分析看板
> 
> 这样表述准确吗？

### ✅ PM 确认
> 对

### 📝 AI 记录
> 已将"不做什么"写入 B1。

---

## 📊 对话统计

- 总对话轮次：2 轮
- PM 决策次数：2 次
- AI 引导次数：2 次
- 写入文件次数：2 次

---

**归档完成时间**: 2025-12-19 15:05:00
```

---

### 方案 2：在工作流中强制要求归档

**修改所有工作流文档**，增加归档要求：

#### B1 工作流修改

在每个 Step 结束后增加：

```markdown
### 📝 归档对话（AI 必须执行）

**AI 必须将本轮对话归档到**：
- 如果是基线阶段：`98_对话归档/B1_对话记录.md`
- 如果是迭代阶段：`98_对话归档/第01轮迭代/B1_对话记录.md`

**归档内容**：
1. AI 的提问
2. PM 的回答
3. AI 的引导/总结
4. PM 的确认
5. 写入文件的记录

**归档时机**：
- 每完成一个部分（目标/Gap/不做）就归档一次
- 不能等到全部完成再归档
```

#### B2 工作流修改

在"战略导师分析"环节增加：

```markdown
### 📝 归档分析过程（AI 必须执行）

**AI 必须将分析和建议归档到**：
`98_对话归档/第01轮迭代/B2_对话记录.md`

**归档内容**：
1. AI 的深度分析
2. AI 的质疑（3 个）
3. PM 的回答
4. AI 的改进建议（3 个）
5. PM 的选择
6. 最终调整的内容
```

---

### 方案 3：提供归档模板

创建 `AI_对话归档模板.md`，让 AI 直接复制使用：

```markdown
# [文档名称] - 对话记录

**创建时间**: [时间]
**迭代轮次**: [第 XX 轮迭代 / 基线阶段]

---

## 💬 对话 #[序号]

**时间**: [时间]  
**讨论主题**: [主题]

### 🤖 AI [提问/分析/建议]
> [AI 的内容]

### 🧑 PM [回答/决策/选择]
> [PM 的内容]

### 🤖 AI [引导/总结/确认]
> [AI 的内容]

### ✅ PM 确认
> [PM 的确认]

### 📝 AI 记录
> [写入了什么]

---

## 📊 对话统计

- 总对话轮次：[N] 轮
- PM 决策次数：[N] 次
- AI 引导次数：[N] 次
- 写入文件次数：[N] 次
```

---

## 🎯 实施步骤

### 步骤 1：修改工作流文档

为以下工作流文档增加"归档对话"要求：
- ✅ prd-p0-project-info.md
- ✅ prd-b1-planning-draft.md
- ✅ prd-b2-planning-breakdown.md
- ✅ prd-c1-requirement-list.md
- ✅ prd-r0-baseline-review.md
- ✅ prd-r1-review.md
- ✅ prd-r2-review.md

### 步骤 2：创建归档模板

创建 `98_对话归档/AI_对话归档模板.md`，提供标准格式

### 步骤 3：在 AI 行为检查清单中增加归档检查

在 `AI工作流执行自我检查报告.md` 中增加：

```markdown
### 我会做到的归档

1. ✅ 每完成一轮对话就归档
2. ✅ 完整记录 AI 的提问和 PM 的回答
3. ✅ 记录 PM 的决策过程（不只是结论）
4. ✅ 使用统一的 Markdown 格式
5. ✅ 及时写入，不等到最后
```

### 步骤 4：修改 init.js

在项目初始化时，自动创建归档模板：

```javascript
// 创建对话归档目录和模板
const dialogDir = path.join(projectPath, '98_对话归档');
await fs.ensureDir(dialogDir);

// 复制归档模板
const templatePath = path.join(__dirname, '../templates/dialog-template.md');
const targetPath = path.join(dialogDir, 'AI_对话归档模板.md');
await fs.copy(templatePath, targetPath);
```

---

## ✅ 修复后的效果

### 修复前

```
98_对话归档/
└── (空目录)
```

### 修复后

```
98_对话归档/
├── AI_对话归档模板.md          # 归档模板
├── P0_对话记录.md              # P0 填写的对话
├── A0_对话记录.md              # A0 填写的对话
├── R0_对话记录.md              # R0 审视的对话
└── 第01轮迭代/
    ├── B1_对话记录.md          # B1 填写的对话（含引导过程）
    ├── B2_对话记录.md          # B2 填写的对话（含分析和建议）
    ├── R1_对话记录.md          # R1 审视的对话
    ├── C1_对话记录.md          # C1 填写的对话
    └── R2_对话记录.md          # R2 审视的对话
```

每个对话记录文件包含：
- ✅ AI 的提问和引导
- ✅ PM 的回答和决策
- ✅ 讨论过程（不只是结论）
- ✅ 时间戳和主题
- ✅ 对话统计

---

## 📋 归档职责划分

| 角色 | 职责 |
|-----|------|
| **AI** | 在对话过程中及时归档，每完成一个部分就写入 |
| **PM** | 审查归档内容，确保记录准确 |
| **CLI** | 记录命令执行的确认（补充性归档）|

---

## 🚨 AI 归档红线

### ❌ 绝对禁止

1. ❌ 对话完了忘记归档
2. ❌ 只记录结论，不记录过程
3. ❌ 等到全部完成再一次性归档
4. ❌ 省略 PM 的原话
5. ❌ 不记录 AI 的引导过程

### ✅ 必须做到

1. ✅ 每轮对话结束立即归档
2. ✅ 完整记录对话过程
3. ✅ 包含时间戳和主题
4. ✅ 使用统一格式
5. ✅ 记录 PM 的原话（不总结）

---

## 🎯 后续优化

### 短期（必须）

1. ✅ 修改所有工作流文档，增加归档要求
2. ✅ 创建归档模板
3. ✅ 在 AI 检查清单中增加归档检查

### 中期（建议）

1. 提供归档助手工具
   ```bash
   prd dialog log "PM 说的话" "AI 说的话" "PM 决策"
   ```

2. 归档质量检查
   - 检查是否有遗漏
   - 检查格式是否统一

### 长期（探索）

1. 自动化归档
   - 监听对话窗口
   - 自动提取对话内容
   - 自动写入归档

2. 归档可视化
   - 生成对话流程图
   - 决策树可视化
   - 时间线展示

---

**修复完成时间**: 待实施  
**预计工作量**: 2-3 小时  
**核心价值**: 确保所有对话过程可追溯
