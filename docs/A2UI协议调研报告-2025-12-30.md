# A2UI 协议调研报告

> **调研日期**：2025-12-30  
> **调研目的**：深入了解 Google A2UI 协议，评估 PRD-CLI 是否需要升级为完整协议支持  
> **结论摘要**：不建议完整升级，保持轻量原型工具定位，有限度借鉴组件规范

---

## 一、背景与动机

### 1.1 调研起因

在使用 PRD-CLI 的 A2UI 功能画原型界面时，发现之前的用法可能存在误区。经过深入调研发现，A2UI 是 Google 在 2025 年 12 月发布的正式开源协议，其定位远超我们之前的理解。

### 1.2 关键发现

**之前的认知**：A2UI 是一个简单的 UI 原型预览工具

**实际定位**：A2UI (Agent-to-User Interface) 是一个开源的声明式协议，用于 AI Agent 动态生成富交互用户界面，可以直接对接后端使用

---

## 二、A2UI 官方协议解读

### 2.1 协议概述

| 属性 | 说明 |
|------|------|
| **名称** | A2UI (Agent-to-User Interface) |
| **开发者** | Google，贡献者包括 CopilotKit 和开源社区 |
| **当前版本** | v0.8 (Public Preview) |
| **许可证** | Apache 2.0 |
| **官网** | https://a2ui.org |
| **GitHub** | https://github.com/google/A2UI |

### 2.2 核心设计哲学

A2UI 协议基于以下核心理念：

#### 1. 安全优先 (Security First)
- 使用声明式 JSON 数据格式，而非可执行代码
- Agent 只能请求使用预批准的组件（Catalog 机制）
- 防止 UI 注入攻击

#### 2. LLM 友好 (LLM-Friendly)
- 扁平化的 JSON 结构，易于 LLM 生成
- 支持增量更新，允许渐进式渲染
- 不要求一次输出完整的 JSON

#### 3. 框架无关 (Framework-Agnostic)
- 同一个 A2UI 消息可在不同平台渲染
- 支持 Angular、Flutter、React、Lit 等框架
- UI 结构与实现完全解耦

#### 4. 渐进式渲染 (Progressive Rendering)
- 流式传输 UI 更新
- 用户可以实时看到界面构建过程
- 无需等待完整响应

### 2.3 协议架构

```
┌─────────────────────────────────────────────────────────────┐
│                      AI Agent (后端)                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │ LLM         │ -> │ 生成 A2UI   │ -> │ JSONL 流    │      │
│  │ (Gemini等)  │    │ Message    │    │ (UI 描述)   │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
└────────────────────────────────┬────────────────────────────┘
                                 │ SSE / WebSocket / A2A
                                 ▼
┌─────────────────────────────────────────────────────────────┐
│                     Client App (前端)                        │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │ 接收 JSONL   │ -> │ A2UI Renderer│ -> │ 原生 UI 组件 │      │
│  │ Stream      │    │ 渲染器      │    │ (AntD/MUI)  │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
│                                                             │
│                    用户交互 ↑ ↓ userAction 回传              │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 核心消息类型

| 消息类型 | 方向 | 说明 |
|---------|------|------|
| `surfaceUpdate` | Server → Client | 定义或更新 UI 组件树 |
| `dataModelUpdate` | Server → Client | 更新应用状态数据 |
| `beginRendering` | Server → Client | 信号客户端开始渲染 |
| `deleteSurface` | Server → Client | 删除 UI 区域 |
| `userAction` | Client → Server | 用户交互事件回传 |
| `error` | Client → Server | 客户端错误报告 |

### 2.5 三大核心解耦

A2UI 的核心哲学是将以下三个元素完全解耦：

1. **组件树 (Component Tree)**
   - Server 提供的抽象组件描述
   - 通过 `surfaceUpdate` 消息定义

2. **数据模型 (Data Model)**
   - Server 提供的动态数据
   - 通过 `dataModelUpdate` 消息管理

3. **组件注册表 (Widget Registry / Catalog)**
   - Client 定义的组件实现映射
   - 将抽象组件类型映射到原生 Widget

只有**组件注册表是需要固化的**，其他都是运行时动态生成的。

### 2.6 A2UI 的典型使用场景

| 场景 | 描述 |
|------|------|
| **动态数据收集** | Agent 根据对话上下文生成定制表单（如预订表单） |
| **远程子 Agent** | 主 Agent 委托远程专业 Agent，后者返回 UI 在主界面渲染 |
| **自适应工作流** | 企业 Agent 根据查询动态生成审批仪表板或数据可视化 |

---

## 三、PRD-CLI 现有 A2UI 实现分析

### 3.1 当前实现概述

| 组件 | 文件位置 | 功能 |
|------|---------|------|
| A2UI Server | `commands/a2ui-server.js` | HTTP 服务器，提供 JSON 数据 |
| A2UI Viewer | `a2ui-viewer/index.html` | React + Ant Design 渲染器 |
| A2UI Template | `templates/a2ui-standalone.html` | 独立 HTML 模板 |
| A2UI Schema | `rules/schemas/a2ui.schema.json` | JSON Schema 定义 |

### 3.2 支持的组件

#### 布局组件
- `Page`, `Panel`, `Row`, `Col`, `Divider`

#### 表单组件
- `Input`, `Textarea`, `Select`, `Button`

#### 展示组件
- `Text`, `Badge`, `Alert`, `Card`, `Table`, `Tabs`, `Upload`

#### 架构图组件
- `Diagram`, `Layer`, `Box`, `Arrow`, `DiagramGroup`

### 3.3 工作流程

```
1. PM 描述需求
   ↓
2. AI 生成 JSON → 写入 .a2ui/current.json
   ↓
3. PM 运行 prd ui 启动预览服务
   ↓
4. PM 在浏览器查看（自动刷新）
   ↓
5. PM 提出修改 → AI 更新 JSON → 刷新查看
   ↓
6. PM 确认 → 保存为正式文件 (.json + .html)
```

### 3.4 与官方 A2UI 的差异

| 维度 | PRD-CLI 实现 | 官方 A2UI 协议 |
|------|-------------|---------------|
| **传输方式** | 轮询 JSON 文件 | JSONL 流（SSE/WebSocket） |
| **渲染模式** | 全量刷新 | 增量更新 + 渐进式渲染 |
| **交互能力** | 静态展示 | 完整事件处理（userAction） |
| **数据绑定** | 无 | 支持 BoundValue 数据绑定 |
| **后端集成** | 无 | 可对接真实 API |
| **多 Surface** | 单一 | 支持多个独立 UI 区域 |

---

## 四、升级可行性分析

### 4.1 升级成本估算

如果要实现完整的 A2UI 协议支持，需要：

| 组件 | 开发内容 | 工作量 |
|------|---------|--------|
| A2UI 服务端 | JSONL 流式传输、消息处理 | 2-3 周 |
| 渲染器升级 | 从静态 HTML 到动态渲染 | 2 周 |
| 事件处理 | userAction 回传机制 | 1 周 |
| Agent 集成 | LLM 实时生成 A2UI | 2-3 周 |
| 数据绑定 | dataModel 和 BoundValue | 1 周 |
| 安全机制 | Catalog 组件白名单 | 1 周 |
| 测试文档 | 完善覆盖和文档 | 1 周 |

**总计：约 10-12 周开发工作**

### 4.2 收益评估

| 收益点 | 对 PRD-CLI 的价值 | 评估 |
|--------|-----------------|------|
| 动态交互 UI | PM 可在原型上直接操作 | 🟡 中等 |
| 后端对接 | 原型展示真实数据 | 🟢 有价值 |
| 流式渲染 | UI 边生成边显示 | 🟡 锦上添花 |
| 跨平台 | 同一 JSON 用于 Web/App | 🔴 不需要 |
| 安全性 | 组件白名单机制 | 🟡 现有够用 |

### 4.3 投入产出矩阵

```
                    收益高
                      │
         ┌────────────┼────────────┐
         │   ❌ 陷阱区  │   ✅ 机会区  │
         │  成本高收益高 │  成本低收益高 │
    成本高├────────────┼────────────┤成本低
         │   ❌ 死亡区  │   🤔 观望区  │
         │  成本高收益低 │  成本低收益低 │
         └────────────┼────────────┘
                      │
                    收益低
                    
完整 A2UI 支持 = 成本高 + 收益中 = ❌ 落入陷阱区
```

---

## 五、结论与建议

### 5.1 核心结论

**不建议将 PRD-CLI 升级为完整的 A2UI 协议支持**

理由：
1. **定位不同**：PRD-CLI 的核心是「需求管理流程」，不是「UI 生成平台」
2. **用户不需要**：PM 需要的是快速预览原型，不是完整的交互应用
3. **投入产出比低**：10+ 周开发换来的能力，对 PM 工作流帮助有限
4. **维护成本高**：A2UI 还在 v0.8 快速演进，跟进成本大

### 5.2 推荐策略：有限度借鉴，保持轻量

#### Phase 1: 完善文档说明（1-2 天）

- 更新 `prd-a2ui-guide.md`，明确说明 PRD-CLI 的 A2UI 是「原型预览工具」
- 增加与官方 A2UI 的关系说明，避免混淆

#### Phase 2: 小幅增强（可选，1 周）

考虑增加简单的动态数据注入能力：

```json
{
  "type": "Table",
  "columns": [...],
  "dataSource": {
    "type": "api",
    "url": "/api/feedback",
    "method": "GET"
  }
}
```

#### Phase 3: 持续关注生态

- 关注 https://github.com/google/A2UI 进展
- 等 v1.0 稳定后再考虑深度集成
- 观察 AI IDE（如 Cursor）是否原生支持 A2UI

### 5.3 更有价值的投资方向

与其投入 10+ 周做完整 A2UI 支持，建议考虑：

| 方向 | 价值 | 工作量 |
|------|------|--------|
| 增强 AI 规则引擎 | 让 AI 更聪明地阻止不规范操作 | 1-2 周 |
| 需求追踪可视化 | 图表展示 A→R→B→C 流转 | 1 周 |
| 协作功能 | 多 PM 协作、评审通知 | 2-3 周 |
| 导出能力 | 生成 Confluence/Notion 格式 | 1 周 |

---

## 六、关键问答记录

### Q1: A2UI 生成的 UI 页面应该保存下来作为固化的应用页面用于开发吗？

**答：不需要**

A2UI 的设计哲学是「UI 即数据流」，不是「UI 即代码资产」：

1. **UI 是对话的一部分**：用户问什么，Agent 生成什么 UI，对话结束 UI 就完成使命
2. **UI 是计算结果**：不是源码，只有组件注册表（Catalog）需要固化
3. **安全架构决定**：保存 JSON 直接使用会绕过安全模型

### Q2: PRD-CLI 的 A2UI 定位应该是什么？

**答：PRD 阶段的原型预览工具**

- ✅ 用于需求评审阶段快速可视化 UI 想法
- ✅ 帮助 PM 和开发团队对齐界面理解
- ❌ 不是生成「生产代码」的工具
- ❌ 不是「完整 A2UI 协议」的实现

---

## 七、参考资料

1. **A2UI 官网**: https://a2ui.org
2. **A2UI GitHub**: https://github.com/google/A2UI
3. **A2UI 协议规范 v0.8**: https://a2ui.org/specification/v0.8-a2ui/
4. **A2UI 核心概念**: https://a2ui.org/concepts/overview/
5. **A2UI 客户端设置指南**: https://a2ui.org/guides/client-setup/

---

## 八、附录

### 附录 A: PRD-CLI A2UI 支持的组件清单

| 类型 | 组件 | 属性 |
|------|------|------|
| 布局 | Page | title, children |
| 布局 | Panel | title, extra, children |
| 布局 | Row | children |
| 布局 | Col | children |
| 布局 | Divider | - |
| 表单 | Input | label, placeholder, required |
| 表单 | Textarea | label, placeholder, rows |
| 表单 | Select | label, options |
| 表单 | Button | text, variant |
| 展示 | Text | content |
| 展示 | Badge | text, variant |
| 展示 | Alert | content, variant |
| 展示 | Card | title, status, actions |
| 展示 | Table | columns, data |
| 展示 | Tabs | items |
| 展示 | Upload | text |
| 架构图 | Diagram | title, children |
| 架构图 | Layer | title, children |
| 架构图 | Box | title, desc, color |
| 架构图 | Arrow | direction, label |
| 架构图 | DiagramGroup | title, children |

### 附录 B: 官方 A2UI 消息示例

**surfaceUpdate 消息**:
```json
{
  "surfaceUpdate": {
    "surfaceId": "main_content_area",
    "components": [
      {
        "id": "submit_btn",
        "component": {
          "Button": {
            "child": "submit_btn_text",
            "action": {
              "name": "submit_form",
              "context": [
                { "key": "userInput", "value": { "path": "/form/textField" } },
                { "key": "formId", "value": { "literalString": "f-123" } }
              ]
            }
          }
        }
      }
    ]
  }
}
```

**dataModelUpdate 消息**:
```json
{
  "dataModelUpdate": {
    "surfaceId": "main_content_area",
    "path": "form",
    "contents": [
      { "key": "textField", "valueString": "User input text" }
    ]
  }
}
```

---

*报告编写：AI Assistant*  
*复盘时间：2025-12-30*
